<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How you can build your own web framework for Node.js</title>
    <meta name="description" content="[object Object]">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.23d22851.css" as="style"><link rel="preload" href="/assets/js/app.24704f31.js" as="script"><link rel="preload" href="/assets/js/9.454b5262.js" as="script"><link rel="preload" href="/assets/js/4.eac68367.js" as="script"><link rel="preload" href="/assets/js/180.0d92fa36.js" as="script"><link rel="prefetch" href="/assets/js/1.36663999.js"><link rel="prefetch" href="/assets/js/10.50c128a6.js"><link rel="prefetch" href="/assets/js/100.832843ee.js"><link rel="prefetch" href="/assets/js/101.58643cde.js"><link rel="prefetch" href="/assets/js/102.c2419951.js"><link rel="prefetch" href="/assets/js/103.005176e9.js"><link rel="prefetch" href="/assets/js/104.74606826.js"><link rel="prefetch" href="/assets/js/105.24c2d5aa.js"><link rel="prefetch" href="/assets/js/106.55618361.js"><link rel="prefetch" href="/assets/js/107.83e2c834.js"><link rel="prefetch" href="/assets/js/108.fcaf3a66.js"><link rel="prefetch" href="/assets/js/109.e4820d72.js"><link rel="prefetch" href="/assets/js/11.a104adc8.js"><link rel="prefetch" href="/assets/js/110.acd428a7.js"><link rel="prefetch" href="/assets/js/111.b728f009.js"><link rel="prefetch" href="/assets/js/112.31679291.js"><link rel="prefetch" href="/assets/js/113.0cea2263.js"><link rel="prefetch" href="/assets/js/114.4d5e3ccd.js"><link rel="prefetch" href="/assets/js/115.6cbd4799.js"><link rel="prefetch" href="/assets/js/116.44cdb765.js"><link rel="prefetch" href="/assets/js/117.f22ffed2.js"><link rel="prefetch" href="/assets/js/118.fda8edf7.js"><link rel="prefetch" href="/assets/js/119.1ea9eae7.js"><link rel="prefetch" href="/assets/js/12.02e6e552.js"><link rel="prefetch" href="/assets/js/120.cf073939.js"><link rel="prefetch" href="/assets/js/121.dc2e4d8b.js"><link rel="prefetch" href="/assets/js/122.b3ca0552.js"><link rel="prefetch" href="/assets/js/123.382bf140.js"><link rel="prefetch" href="/assets/js/124.b791f567.js"><link rel="prefetch" href="/assets/js/125.88e1d9ef.js"><link rel="prefetch" href="/assets/js/126.dc6e1538.js"><link rel="prefetch" href="/assets/js/127.66804437.js"><link rel="prefetch" href="/assets/js/128.17f62a6f.js"><link rel="prefetch" href="/assets/js/129.57ea763a.js"><link rel="prefetch" href="/assets/js/13.215ad842.js"><link rel="prefetch" href="/assets/js/130.58e7dbf8.js"><link rel="prefetch" href="/assets/js/131.42d28338.js"><link rel="prefetch" href="/assets/js/132.5905a839.js"><link rel="prefetch" href="/assets/js/133.0209a5d4.js"><link rel="prefetch" href="/assets/js/134.e0ba3c0c.js"><link rel="prefetch" href="/assets/js/135.9daa05c5.js"><link rel="prefetch" href="/assets/js/136.5fed2e61.js"><link rel="prefetch" href="/assets/js/137.afa1f455.js"><link rel="prefetch" href="/assets/js/138.86e59e71.js"><link rel="prefetch" href="/assets/js/139.c32904ca.js"><link rel="prefetch" href="/assets/js/14.1a060010.js"><link rel="prefetch" href="/assets/js/140.b91b86f6.js"><link rel="prefetch" href="/assets/js/141.dce0c98e.js"><link rel="prefetch" href="/assets/js/142.a720f1cc.js"><link rel="prefetch" href="/assets/js/143.5dd23bb9.js"><link rel="prefetch" href="/assets/js/144.7637c352.js"><link rel="prefetch" href="/assets/js/145.62cbf79d.js"><link rel="prefetch" href="/assets/js/146.64a5dfee.js"><link rel="prefetch" href="/assets/js/147.bf8a0bfa.js"><link rel="prefetch" href="/assets/js/148.255d1e0a.js"><link rel="prefetch" href="/assets/js/149.a1ea7d62.js"><link rel="prefetch" href="/assets/js/15.34674cd6.js"><link rel="prefetch" href="/assets/js/150.dae3400c.js"><link rel="prefetch" href="/assets/js/151.30a5ae9d.js"><link rel="prefetch" href="/assets/js/152.f7d2856c.js"><link rel="prefetch" href="/assets/js/153.1f3dfd3e.js"><link rel="prefetch" href="/assets/js/154.f5e761e3.js"><link rel="prefetch" href="/assets/js/155.487cb1ac.js"><link rel="prefetch" href="/assets/js/156.87dff4f6.js"><link rel="prefetch" href="/assets/js/157.e46db977.js"><link rel="prefetch" href="/assets/js/158.78548438.js"><link rel="prefetch" href="/assets/js/159.6e55156d.js"><link rel="prefetch" href="/assets/js/16.119e91d4.js"><link rel="prefetch" href="/assets/js/160.5d45aa73.js"><link rel="prefetch" href="/assets/js/161.71318bd8.js"><link rel="prefetch" href="/assets/js/162.c8cea25d.js"><link rel="prefetch" href="/assets/js/163.a7833ee3.js"><link rel="prefetch" href="/assets/js/164.52d537cd.js"><link rel="prefetch" href="/assets/js/165.2158f290.js"><link rel="prefetch" href="/assets/js/166.7edeee8d.js"><link rel="prefetch" href="/assets/js/167.d0986a2c.js"><link rel="prefetch" href="/assets/js/168.aee92853.js"><link rel="prefetch" href="/assets/js/169.f1c69f9e.js"><link rel="prefetch" href="/assets/js/17.780050f1.js"><link rel="prefetch" href="/assets/js/170.7788d661.js"><link rel="prefetch" href="/assets/js/171.a9a9a27a.js"><link rel="prefetch" href="/assets/js/172.d04eb1b7.js"><link rel="prefetch" href="/assets/js/173.198a9e81.js"><link rel="prefetch" href="/assets/js/174.a5fb669c.js"><link rel="prefetch" href="/assets/js/175.931caef2.js"><link rel="prefetch" href="/assets/js/176.79d52a25.js"><link rel="prefetch" href="/assets/js/177.3d157478.js"><link rel="prefetch" href="/assets/js/178.b32955d2.js"><link rel="prefetch" href="/assets/js/179.0932be53.js"><link rel="prefetch" href="/assets/js/18.6ebceaf1.js"><link rel="prefetch" href="/assets/js/181.8db46515.js"><link rel="prefetch" href="/assets/js/182.a244df15.js"><link rel="prefetch" href="/assets/js/183.512d251b.js"><link rel="prefetch" href="/assets/js/184.ec464230.js"><link rel="prefetch" href="/assets/js/185.b987c6e1.js"><link rel="prefetch" href="/assets/js/186.d52074ed.js"><link rel="prefetch" href="/assets/js/187.9e85ad4d.js"><link rel="prefetch" href="/assets/js/188.9025b82e.js"><link rel="prefetch" href="/assets/js/189.29cd70a4.js"><link rel="prefetch" href="/assets/js/19.910fc8d0.js"><link rel="prefetch" href="/assets/js/190.d01adc16.js"><link rel="prefetch" href="/assets/js/191.67b96f38.js"><link rel="prefetch" href="/assets/js/192.df764c7c.js"><link rel="prefetch" href="/assets/js/193.42944620.js"><link rel="prefetch" href="/assets/js/194.38c50b13.js"><link rel="prefetch" href="/assets/js/195.7a74351d.js"><link rel="prefetch" href="/assets/js/196.ef5a9160.js"><link rel="prefetch" href="/assets/js/197.d2c4a013.js"><link rel="prefetch" href="/assets/js/198.5b732bba.js"><link rel="prefetch" href="/assets/js/199.72ae3d2d.js"><link rel="prefetch" href="/assets/js/20.f2e93d17.js"><link rel="prefetch" href="/assets/js/200.d270f882.js"><link rel="prefetch" href="/assets/js/201.b9725a58.js"><link rel="prefetch" href="/assets/js/202.29dec5af.js"><link rel="prefetch" href="/assets/js/203.c72e7565.js"><link rel="prefetch" href="/assets/js/21.710dadb0.js"><link rel="prefetch" href="/assets/js/22.f4b7a74b.js"><link rel="prefetch" href="/assets/js/23.fa51555f.js"><link rel="prefetch" href="/assets/js/24.284f93d3.js"><link rel="prefetch" href="/assets/js/25.a9fce161.js"><link rel="prefetch" href="/assets/js/26.e3067144.js"><link rel="prefetch" href="/assets/js/27.9c9ebb3b.js"><link rel="prefetch" href="/assets/js/28.f1b496e3.js"><link rel="prefetch" href="/assets/js/29.08e9944c.js"><link rel="prefetch" href="/assets/js/3.970a66a4.js"><link rel="prefetch" href="/assets/js/30.e5e5c59b.js"><link rel="prefetch" href="/assets/js/31.0cc11bf2.js"><link rel="prefetch" href="/assets/js/32.f2e286bb.js"><link rel="prefetch" href="/assets/js/33.eb167d44.js"><link rel="prefetch" href="/assets/js/34.1a668786.js"><link rel="prefetch" href="/assets/js/35.ccde8210.js"><link rel="prefetch" href="/assets/js/36.350691e2.js"><link rel="prefetch" href="/assets/js/37.59283e16.js"><link rel="prefetch" href="/assets/js/38.ec99f979.js"><link rel="prefetch" href="/assets/js/39.18b0acf7.js"><link rel="prefetch" href="/assets/js/40.c95b5321.js"><link rel="prefetch" href="/assets/js/41.390ffe47.js"><link rel="prefetch" href="/assets/js/42.66bb07f8.js"><link rel="prefetch" href="/assets/js/43.9a56b84d.js"><link rel="prefetch" href="/assets/js/44.1ca19751.js"><link rel="prefetch" href="/assets/js/45.3024117c.js"><link rel="prefetch" href="/assets/js/46.74ac226f.js"><link rel="prefetch" href="/assets/js/47.2a0e468e.js"><link rel="prefetch" href="/assets/js/48.ebef90c8.js"><link rel="prefetch" href="/assets/js/49.33d9d0c4.js"><link rel="prefetch" href="/assets/js/5.d1da013e.js"><link rel="prefetch" href="/assets/js/50.d3ddc342.js"><link rel="prefetch" href="/assets/js/51.4466aba2.js"><link rel="prefetch" href="/assets/js/52.e69de275.js"><link rel="prefetch" href="/assets/js/53.4d5b9ce7.js"><link rel="prefetch" href="/assets/js/54.222addc9.js"><link rel="prefetch" href="/assets/js/55.ee80e16b.js"><link rel="prefetch" href="/assets/js/56.8246b35d.js"><link rel="prefetch" href="/assets/js/57.1c4677b9.js"><link rel="prefetch" href="/assets/js/58.731c5de0.js"><link rel="prefetch" href="/assets/js/59.2f91ecc3.js"><link rel="prefetch" href="/assets/js/6.9bdf2d86.js"><link rel="prefetch" href="/assets/js/60.67ca9192.js"><link rel="prefetch" href="/assets/js/61.61f01cf6.js"><link rel="prefetch" href="/assets/js/62.24f5a40d.js"><link rel="prefetch" href="/assets/js/63.60a38d5b.js"><link rel="prefetch" href="/assets/js/64.298ecd6c.js"><link rel="prefetch" href="/assets/js/65.a5e5b25b.js"><link rel="prefetch" href="/assets/js/66.ed942689.js"><link rel="prefetch" href="/assets/js/67.20ca5d8a.js"><link rel="prefetch" href="/assets/js/68.51a766d8.js"><link rel="prefetch" href="/assets/js/69.2f1186ea.js"><link rel="prefetch" href="/assets/js/7.8cd56b2f.js"><link rel="prefetch" href="/assets/js/70.8f3a0f45.js"><link rel="prefetch" href="/assets/js/71.f2d8b3eb.js"><link rel="prefetch" href="/assets/js/72.e816ed3a.js"><link rel="prefetch" href="/assets/js/73.d791feee.js"><link rel="prefetch" href="/assets/js/74.5973a4fb.js"><link rel="prefetch" href="/assets/js/75.760ceb86.js"><link rel="prefetch" href="/assets/js/76.232ad0b0.js"><link rel="prefetch" href="/assets/js/77.49a534d4.js"><link rel="prefetch" href="/assets/js/78.134a5d5e.js"><link rel="prefetch" href="/assets/js/79.986ee003.js"><link rel="prefetch" href="/assets/js/8.6b13a443.js"><link rel="prefetch" href="/assets/js/80.f2ed7194.js"><link rel="prefetch" href="/assets/js/81.b53946f2.js"><link rel="prefetch" href="/assets/js/82.5a42831f.js"><link rel="prefetch" href="/assets/js/83.1bec09df.js"><link rel="prefetch" href="/assets/js/84.f8c4a382.js"><link rel="prefetch" href="/assets/js/85.569d3ef1.js"><link rel="prefetch" href="/assets/js/86.f7c2d0fe.js"><link rel="prefetch" href="/assets/js/87.66375412.js"><link rel="prefetch" href="/assets/js/88.4904c176.js"><link rel="prefetch" href="/assets/js/89.ceed231e.js"><link rel="prefetch" href="/assets/js/90.b9e7590b.js"><link rel="prefetch" href="/assets/js/91.cd9f26cc.js"><link rel="prefetch" href="/assets/js/92.09574fb8.js"><link rel="prefetch" href="/assets/js/93.7d20df23.js"><link rel="prefetch" href="/assets/js/94.05e51833.js"><link rel="prefetch" href="/assets/js/95.90bc71f0.js"><link rel="prefetch" href="/assets/js/96.223a0481.js"><link rel="prefetch" href="/assets/js/97.607b5c0c.js"><link rel="prefetch" href="/assets/js/98.a8e011ae.js"><link rel="prefetch" href="/assets/js/99.1d4527be.js">
    <link rel="stylesheet" href="/assets/css/0.styles.23d22851.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>How you can build your own web framework for Node.js</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/javascript-web-framework.html#an-example-express-app" class="sidebar-link">An example express App</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/javascript-web-framework.html#a-vanilla-http-app" class="sidebar-link">A Vanilla HTTP app</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/javascript-web-framework.html#implementing-routing-and-http-verbs" class="sidebar-link">Implementing routing and HTTP Verbs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/javascript-web-framework.html#http-verb-methods" class="sidebar-link">HTTP Verb methods</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-web-framework.html#parsing-route-parameters" class="sidebar-link">Parsing route parameters</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-web-framework.html#adding-routing-to-the-server" class="sidebar-link">Adding routing to the server</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-web-framework.html#query-parameters" class="sidebar-link">Query parameters</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-web-framework.html#sending-data-with-a-body" class="sidebar-link">Sending data with a Body</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-web-framework.html#response-helpers" class="sidebar-link">Response helpers</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-web-framework.html#middleware" class="sidebar-link">Middleware</a></li></ul></li><li><a href="/pages/javascript-web-framework.html#summary" class="sidebar-link">Summary</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p># How you can build your own web framework for Node.js</p> <p>Follow me on <a href="https://twitter.com/chris_noring" target="_blank" rel="noopener noreferrer">Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, happy to take your suggestions on topics or improvements /Chris</p> <p><img src="https://dev-to-uploads.s3.amazonaws.com/i/u21viylubqliso0b44kl.jpg" alt=""></p> <p>TLDR; this article teaches you to implement the framework Express to a certain degree. Great for your own learning but don't use in production unless you got issues with space or bandwidth doing an NPM install. Hope it's helpful</p> <p>The reason I write these kinds of articles is not that I want people to reinvent the wheel but to learn from the experience. I bet if you search npmjs you would find 100s of implementations looking more or less like one of the big known frameworks, Express, Nest, Koa, or Fastify. So what would creating one more framework do? Isn't that a waste of time? I don't think so and the reason is that you can learn a lot by trying to implement it yourself. You can acquire skills that help you in your everyday web dev life. It can also set you up nicely for OSS work as you now <em>see the Matrix</em>.</p> <p>## Implementing the Express framework</p> <p>For this article, I've chosen to try to implement a part of the Express framework. What parts is that exactly?</p> <ul><li><strong>Routes</strong>, Express has a way of associating specific routes and have specific code run if a route is hit. You are also able to differentiate routes based on HTTP Verb. So a GET to <code>/products</code> is different from a <code>POST</code> to <code>/products</code>.</li> <li><strong>Middleware</strong>, is a piece of code that can run before or after your request and even control what should happen to the request. Middleware is how you could inspect a header for an auth token and if valid return the asked for resources. If the token is not valid then the request stops there and a suitable message can be sent back.</li> <li><strong>Query parameters</strong>, this is the end part of the URL and is able to help further filter down what you want the response to look at. Given a URL looking like so <code>/products?page=1&amp;pagesize=20</code>, the query parameters are everything that happens after <code>?</code>.</li> <li><strong>Sending data with a Body</strong>, data can be sent from the client to the server application. It can be sent either over the URL or through a body. The body can contain different things, everything from JSON to simple form fields to even files.</li></ul> <h2 id="an-example-express-app"><a href="#an-example-express-app" aria-hidden="true" class="header-anchor">#</a> An example express App</h2> <p>Let's look at a few lines of implementing an Express app. There are a lot of things happening even with a few lines:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/products/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`You sent id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server up and running on port 3000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="a-vanilla-http-app"><a href="#a-vanilla-http-app" aria-hidden="true" class="header-anchor">#</a> A Vanilla HTTP app</h2> <p>How would we go about implementing that? Well, we have the HTTP module at our disposal. So let's look at a very small implementation to understand what's missing:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>The HTTP module only has a very basic sense of routing. If you navigate toward such an app with URL <code>http://localhost:3000/products</code> the <code>req.url</code> will contain <code>/products</code> and <code>req.method</code> will contain the string <code>get</code>. That's it, that's all you have.</p> <h2 id="implementing-routing-and-http-verbs"><a href="#implementing-routing-and-http-verbs" aria-hidden="true" class="header-anchor">#</a> Implementing routing and HTTP Verbs</h2> <p>We are about to implement the following</p> <ul><li><strong>HTTP Verb methods</strong>, we need methods like <code>get()</code>, <code>post()</code> etc.</li> <li><strong>Routing and route parameters</strong>, we need to be able to match <code>/products</code> and we need to be able to break out the route parameter id from an expression looking like this <code>/products/:id</code>.</li> <li><strong>Query parameters</strong>, we should be able to take a URL like so <code>http://localhost:3000/products?page=1&amp;pageSize=20</code> and parse out the parameters <code>page</code> and <code>pageSize</code> so that they are easy to work with.</li></ul> <h3 id="http-verb-methods"><a href="#http-verb-methods" aria-hidden="true" class="header-anchor">#</a> HTTP Verb methods</h3> <p>Let's create a <code>server.js</code> and start implementing our server like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">myServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> routeTable <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'get'</span><span class="token punctuation">:</span> cb <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Let's leave the code like that and continue to implement the routing.</p> <h3 id="parsing-route-parameters"><a href="#parsing-route-parameters" aria-hidden="true" class="header-anchor">#</a> Parsing route parameters</h3> <p>Implementing <code>/products</code> is easy, that's just string comparison with or without RegEx. Digging out an <code>id</code> parameter from <code>/products/:id</code> is slightly more tricky. We can do so with a RegEx once we realize that <code>/product/:id</code> can be rewritten as the RegEx <code>/products/:(?&lt;id&gt;\w+)</code>. This is a so-called named group that when we run the <code>match()</code> method will return an object containing a <code>groups</code> property with content like so <code>{ id: '1' }</code> for a route looking like so <code>/products/1</code>. Let's show such an implementation:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// url-to-regex.js</span>

<span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> url<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> c <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// eat all characters</span>
      <span class="token keyword">let</span> param <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> url<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\w/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          param <span class="token operator">+=</span> url<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      str <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`(?&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;\\w+)`</span></span><span class="token punctuation">;</span>
      i <span class="token operator">=</span> j <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      str <span class="token operator">+=</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> str<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> parse<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>And to use it:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> parse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./url-to-regex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;/products/:id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;/products/(?&lt;id&gt;\\w+)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token string">&quot;/products/114&quot;</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// match.groups is { id: '114' }     </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="adding-routing-to-the-server"><a href="#adding-routing-to-the-server" aria-hidden="true" class="header-anchor">#</a> Adding routing to the server</h3> <p>Let's open up our <code>server.js</code> file again and add the route management part.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./regex-from-url'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">myServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> routeTable <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> routes <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>routeTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> match <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> routes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">const</span> route <span class="token operator">=</span> routes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token keyword">const</span> parsedRoute <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>
         <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>parsedRoute<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
         routeTable<span class="token punctuation">[</span>route<span class="token punctuation">]</span><span class="token punctuation">[</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
       <span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">let</span> cb <span class="token operator">=</span> routeTable<span class="token punctuation">[</span>route<span class="token punctuation">]</span><span class="token punctuation">[</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         
         <span class="token keyword">const</span> m <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>parsedRoute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
         req<span class="token punctuation">.</span>params <span class="token operator">=</span> m<span class="token punctuation">.</span>groups<span class="token punctuation">;</span>
         
         <span class="token function">cb</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
         
         match <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'get'</span><span class="token punctuation">:</span> cb <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>What we are doing is looping through all the routes in our route dictionary until we find a match. The comparison looks like this:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>parsedRoute<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  routeTable<span class="token punctuation">[</span>route<span class="token punctuation">]</span><span class="token punctuation">[</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Note also how the router params are parsed and placed on the <code>params</code> property like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> m <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>parsedRoute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>params <span class="token operator">=</span> m<span class="token punctuation">.</span>groups<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="query-parameters"><a href="#query-parameters" aria-hidden="true" class="header-anchor">#</a> Query parameters</h3> <p>We already know that using the HTTP module, the URL will contain our route, like so <code>/products?page=1&amp;pageSize</code>. The next step is to dig out those parameters. That can be accomplished by using a RegEx like and the below code:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// query-params.js</span>
  
<span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\?(?&lt;query&gt;.*)/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> groups<span class="token punctuation">:</span> <span class="token punctuation">{</span> query <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> results<span class="token punctuation">;</span>

  <span class="token keyword">const</span> pairs <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/(?&lt;param&gt;\w+)=(?&lt;value&gt;\w+)/g</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> pairs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> curr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token operator">=</span> curr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    acc<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> acc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> params<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> parse<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Now we need to tie that into the server code. That's just a few lines, fortunately:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> queryParse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./query-params.js'</span><span class="token punctuation">)</span>

<span class="token comment">// the rest omitted for brevity</span>
ress<span class="token punctuation">.</span>query <span class="token operator">=</span> <span class="token function">queryParse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="sending-data-with-a-body"><a href="#sending-data-with-a-body" aria-hidden="true" class="header-anchor">#</a> Sending data with a Body</h3> <p>Reading the body can be done by realizing that the input parameter <code>req</code> is of type stream. It's good to know that data arrives in small pieces, so-called chunks. By listening to the event <code>end</code> the client is letting is now that the transmission is complete and no more data will be sent.</p> <p>You can listen to incoming data by listening to the event <code>data</code>, like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// no more data</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>To implement listening to data being transmitted from a client we can, therefore, create the following helper method:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">readBody</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        body <span class="token operator">+=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> chunk<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>and then use it in our server code like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>res<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readBody</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The full code at this point should look like this:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// server.js</span>

<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> queryParse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./query-params.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./regex-from-url'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">readBody</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        body <span class="token operator">+=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> chunk<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">myServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> routeTable <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> routes <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>routeTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> match <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> routes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">const</span> route <span class="token operator">=</span> routes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token keyword">const</span> parsedRoute <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>
         <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>parsedRoute<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
         routeTable<span class="token punctuation">[</span>route<span class="token punctuation">]</span><span class="token punctuation">[</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
       <span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">let</span> cb <span class="token operator">=</span> routeTable<span class="token punctuation">[</span>route<span class="token punctuation">]</span><span class="token punctuation">[</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         
         <span class="token keyword">const</span> m <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>parsedRoute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
         req<span class="token punctuation">.</span>params <span class="token operator">=</span> m<span class="token punctuation">.</span>groups<span class="token punctuation">;</span>
         req<span class="token punctuation">.</span>query <span class="token operator">=</span> <span class="token function">queryParse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
         req<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readBody</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
         
         <span class="token function">cb</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
         
         match <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;Not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'get'</span><span class="token punctuation">:</span> cb <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'post'</span><span class="token punctuation">:</span> cb <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>At this point you should be able to call your code like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./server'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/products/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// for route /products/1, req.params has value  { id: '1' }</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/products/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// for route /products?page=1&amp;pageSize=10, req.query has value  { page: '1', pageSize: '10' }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/products/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// req.body should contain whatever you sent across as client</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="response-helpers"><a href="#response-helpers" aria-hidden="true" class="header-anchor">#</a> Response helpers</h3> <p>At this point, a lot is working. But how do you actually return data back to the client? Because you are implementing the HTTP module the <code>res</code> parameter can be used. By calling its <code>end()</code> you can send data back. Here's an example:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'some data'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>However, if you look at how Express does it, it has all sorts of helpers for this like <code>send()</code>, <code>json()</code>, <code>html()</code> and so on. You can have that too with a few lines of code:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createResponse</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function-variable function">json</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function-variable function">html</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>and make sure you add it in the server code:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>res <span class="token operator">=</span> <span class="token function">createResponse</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="middleware"><a href="#middleware" aria-hidden="true" class="header-anchor">#</a> Middleware</h3> <p>Having middleware allows us to run code before or after the request, or even control the request itself. Have a look at the following code:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/protected&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;abc123&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Not allowed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;protected route&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>The second argument is the middleware. It inspects <code>req.headers</code> for an <code>authorization</code> property and checks its value. If everything is ok it invokes <code>next()</code>. If it's not ok then the request stop here and <code>res.send()</code> is invoked and status code set to <code>401</code>, not allowed.</p> <p>The last argument is the route response you want the client to see providing they send you an ok header value.</p> <p>Let's implement this. Create the following function in <code>server.js</code>:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">processMiddleware</span><span class="token punctuation">(</span><span class="token parameter">middleware<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// resolve false</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">middleware</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Above the <code>middleware</code> param is being called and you can see how the last argument to it is a function that resolves a Promise like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">middleware</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>For the server code to use this, there are a few steps we need to take:</p> <ol><li>Ensure we register the middleware</li> <li>Get a hold of the middleware when we have a matching request</li> <li>Call the middleware</li></ol> <p><strong>Register middleware</strong></p> <p>We need to change slightly how we register routes by first adding this helper method:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">registerPath</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> method<span class="token punctuation">,</span> middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>routeTable<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">:</span> cb<span class="token punctuation">,</span> <span class="token punctuation">[</span>method <span class="token operator">+</span> <span class="token string">&quot;-middleware&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span> middleware <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>So trying to register a route like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/products'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>leads to the middleware callback being saved on a property <code>get-middleware</code></p> <p>Then when we register the route we do something like this instead:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> <span class="token operator">...</span>rest</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rest<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">registerPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> rest<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">registerPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> rest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> rest<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>Get a reference to the middleware</strong></p> <p>To get a reference to the middleware we can use this code:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> middleware <span class="token operator">=</span> routeTable<span class="token punctuation">[</span>route<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-middleware`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>Process middleware</strong></p> <p>Finally, to run the middleware write the below code:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">processMiddleware</span><span class="token punctuation">(</span>middleware<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token function">createResponse</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cb</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>The full code is available at this repo:</p> <blockquote><p>https://github.com/softchris/mini-web</p></blockquote> <p>and it can also be used via NPM by calling:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> quarkhttp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>That was a lot, routing, routing parameters, query parameters, body parsing, and middleware. Hopefully, you can now understand what's going on. Remember that there are great libraries out there for you to use that are well tested. However, understanding how things are implemented can be really beneficial for your understanding.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.24704f31.js" defer></script><script src="/assets/js/9.454b5262.js" defer></script><script src="/assets/js/4.eac68367.js" defer></script><script src="/assets/js/180.0d92fa36.js" defer></script>
  </body>
</html>
